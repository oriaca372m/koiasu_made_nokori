<!doctype html>
<html lang="ja">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

		<link rel="canonical" href="https://oriaca372m.github.io/koiasu_made_nokori/">

		<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js" integrity="sha256-4iQZ6BVL4qNKlQ27TExEhBN1HFPvAvAMbFavKKosSWQ=" crossorigin="anonymous"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/moment-duration-format/2.3.2/moment-duration-format.min.js" integrity="sha256-M2KULKSJyw+G0068JiMlM9GX4XpLdUButSzBqntKDZM=" crossorigin="anonymous"></script>

		<script type="text/javascript">
			"use strict";

			function generateText(now, target) {
				let startTime;
				let episodeNumber;
				let isAfterFinalEpisode = true;

				for (let i = 0; i < target.time.length; i++) {
					if (now.isBefore(target.time[i])) {
						isAfterFinalEpisode = false;
						episodeNumber = i + 1;
						startTime = target.time[i];
						break;
					}
				}

				if (isAfterFinalEpisode) {
					return {
						main: '放送終了',
						sub: '',
						tweet: `恋する小惑星の放送は終了しました。 (${target.name})`
					};
				}

				const diffDuration = moment.duration(startTime.diff(now));
				const timeLeftMsg = diffDuration.format('Y年Mヶ月D日hh時間mm分ss.SS秒', { trim: true });

				if (episodeNumber === 1) {
					return {
						main: timeLeftMsg,
						sub: '',
						tweet: `恋する小惑星まで残り ${timeLeftMsg} (${target.name})`
					};
				}

				return {
					main: `放送開始`,
					sub: `${episodeNumber}話まで残り ${timeLeftMsg}`,
					tweet: `恋する小惑星は放送開始しました! ${episodeNumber}話まで残り ${timeLeftMsg} (${target.name})`
				};
			}

			function generateChannelUrl(channel) {
				let url = new URL('https://oriaca372m.github.io/koiasu_made_nokori/');
				url.searchParams.append('channel', channel);
				return url.toString();
			}

			function generateTimeTable(targetTable, finalEpisode) {
				const retTable = new Map();

				for (const [key, value] of targetTable) {
					const time = [];
					const vtime = value.time

					let oldTime = vtime.get(1);
					time.push(oldTime);

					for (let i = 2; i <= finalEpisode; i++) {
						const currentTime = vtime.has(i) ? vtime.get(i) : oldTime.clone().add(7, 'd');

						time.push(currentTime);
						oldTime = currentTime;
					}

					retTable.set(key, { name: value.name, time });
				}

				return retTable;
			}

			const targetTable = new Map([
				['atx', {
					name: 'AT-X',
					time: new Map([
						[1, moment('2020-01-03T20:30:00')]
					])
				}],
				['tokyomx', {
					name: 'TOKYO MX',
					time: new Map([
						[1, moment('2020-01-03T23:00:00')],
						[2, moment('2020-01-10T22:30:00')]
					])
				}],
				['suntv', {
					name: 'サンテレビ',
					time: new Map([
						[1, moment('2020-01-03T24:00:00')]
					])
				}],
				['kbskyoto', {
					name: 'KBS京都',
					time: new Map([
						[1, moment('2020-01-03T24:00:00')]
					])
				}],
				['tvaichi', {
					name: 'テレビ愛知',
					time: new Map([
						[1, moment('2020-01-11T03:05:00')],
						[2, moment('2020-01-11T03:35:00')],
						[3, moment('2020-01-18T03:05:00')]
					])
				}],
				['bs11', {
					name: 'BS11',
					time: new Map([
						[1, moment('2020-01-03T23:00:00')]
					])
				}]
			]);

			const finalEpisode = 12;
			const timeTable = generateTimeTable(targetTable, finalEpisode);

			let targetId = 'atx';

			{
				const params = new URLSearchParams(window.location.search);
				const channel = params.get('channel');
				if (channel !== null && targetTable.has(channel)) {
					targetId = channel;
				}
			}

			document.addEventListener('DOMContentLoaded', (e) => {
				const display = document.getElementById('time-display');
				const subdisplay = document.getElementById('time-sub-display');

				const channel = document.getElementById('channel');

				for (const [key, value] of targetTable) {
					const elm = document.createElement('option');
					elm.setAttribute('value', key);
					elm.appendChild(document.createTextNode(value.name));
					channel.appendChild(elm);
				}

				channel.value = targetId;

				channel.addEventListener('change', (e) => {
					targetId = e.target.value;
					window.history.replaceState(null, null, generateChannelUrl(targetId));
				});

				window.setInterval(() => {
					const text = generateText(moment(), timeTable.get(targetId));
					display.textContent = text.main;
					subdisplay.textContent = text.sub;
				}, 10);

				document.getElementById('tweet').addEventListener('click', (e) => {
					let url = new URL('https://twitter.com/intent/tweet');
					url.searchParams.append('text', generateText(moment(), timeTable.get(targetId)).tweet);
					url.searchParams.append('url', generateChannelUrl(targetId));
					url.searchParams.append('hashtags', 'koias');
					window.open().location.href = url.toString();
				});
			});
		</script>

		<title>恋する小惑星まで残り</title>
	</head>
	<body>
		<h1>恋する小惑星まで残り</h1>
		<select id="channel" style="font-size: 25px;"></select>
		<p id="time-display" style="font-size: 50px; text-align: center;"></p>
		<p id="time-sub-display" style="font-size: 30px; text-align: center;"></p>
		<button type="button" id="tweet" style="font-size: 25px;">ツイート</button>
		<p>放送時間の取得元: <a href="http://koiastv.com/onair.html">http://koiastv.com/onair.html</a></p>
	</body>
</html>
